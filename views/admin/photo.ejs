<% include partials/_header_logged_in %>

<main class="photos-page">

  <div class="form-wrapper">

    <form action="/admin/photo" method="post">

      <div>
        <input class="title" type="text" name="title" placeholder="Title" />
        <textarea class="description" type="text" name="description" placeholder="Description"></textarea>
      </div>

      <div class="sr-only">
        <label for="file">File</label>
        <input class="image-uploader" type="file" name="file" />
      </div>

      <button type="submit" name="button" disabled>Submit</button>

    </form>

    <div>

      <div class="image-upload-handler">
        <i class="fa fa-plus-circle" aria-hidden="true"></i>
      </div>

      <img src="" alt="" class="img-preview" />

    </div>


  </div>

  <div class="photo-gallery">

    <% photos.forEach((photo, index) => { %>
      <div class="photo">
        <img src="<%= photo.url %>" alt="<%= photo.title %>" />
        <h2><%= photo.title %></h2>
        <p><%= photo.description %></p>
      </div>
      <% }) %>

  </div>

</main>

<script type="text/javascript">

  const fileInput = document.querySelector('.image-uploader')
  const titleInput = document.querySelector('.title')
  const descriptionInput = document.querySelector('.description')
  const imgPreview = document.querySelector('.img-preview')
  const imgUploadHandler = document.querySelector('.image-upload-handler')
  const submitBtn = document.querySelector('button')

  titleInput.addEventListener('keyup', () => {
    validateForm()
  })

  imgUploadHandler.addEventListener('click', () => {
    fileInput.click()
  })

  fileInput.addEventListener('change', () => {
    console.log('FILE CHANGING')
    const fileReader = new FileReader()
    fileReader.addEventListener('load', () => {
      console.log('FILE LOADED', fileReader.result)
      imgPreview.src = fileReader.result;
      imgUploadHandler.style.display = 'none';
      validateForm()
    })
    fileReader.readAsDataURL(fileInput.files[0])
  })

  function validateForm() {
    if (fileInput.files[0] && titleInput.value.trim()) {
      submitBtn.disabled = false;
    } else {
      submitBtn.disabled = true;
    }
  }

  function submit(e) {
    e.preventDefault()
    console.log('FORM ABOUT TO SUBMIT FOR REAL', fileInput.files[0])
    const fileReader = new FileReader()
    fileReader.readAsDataURL(fileInput.files[0])
    fileReader.addEventListener('load', () => {
      const image = fileReader.result;
      const title = titleInput.value;
      const description = descriptionInput.value;
      fetch('/admin/photo', {
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        },
        method: 'POST',
        body: JSON.stringify({
          title,
          description,
          image
        })
      }).then((response) => {
        console.log('RESPONSE', response)
        if (response.status === 200) {
          window.location.reload()
        } else {
          alert('THERE WAS AN ERROR SAVING THE PHOTO')
        }
      }).catch((err) => {
        console.error('ERROR POSTING IMAGE', err);
      })
    })
  }

  submitBtn.addEventListener('click', (e) => {
    submit(e)
  })

</script>

<% include partials/_footer %>
